# ERPE 生态与种群-势力统一设计草案

> 目标：在同一套 ERPE（Entity / Resource / Process / Effect）框架下，  
统一表现：个体、种群、势力（派系），  
支持刷怪、素材获取、生态观察，以及政治/经济等高等行为的“涌现”。

---

## 0. 总体思想

1. **个体 / 种群 / 势力，本质上都是 Entity**  

    只是挂的组件不同，操作它们的 Process 粒度统一。
2. **区分“个体真实层”和“种群统计层”**  
    - 玩家附近（高精度区，HQ）：  

        个体 Creature 负责“真实生死迁移”，种群只是统计视图。
    - 远处区域（低精度区，LQ）：  

        Population 实体负责“真实生死迁移”，个体仅用于抽样表现或不存在。
3. **迁移、生灭、加入/退出势力，全都是标准 Process + Effect**  

    不额外发明“特殊逻辑系统”，只在 ERPE 中增加一些“生态/社会”类的原子 Process。

---

## 1. 三个层级统一在 Entity + Component 上

### 1.1 Entity 基础结构

```text
Entity:
  id: EntityId
  type: "Creature" | "Population" | "Faction" | "Location" | ...
  components: Map<ComponentType, ComponentData>
```

### 1.2 个体 Creature

```text
type: "Creature"
components:
  C_CreatureLife:
    HP
    Hunger
    Age
    ReproductionDrive
    ...（其它生理资源）
  C_Position:
    world_pos
    region_id
  C_SpeciesRef:
    species_id
  C_FactionRef (可选):
    faction_id
  C_Traits:
    aggression
    sociability
    intelligence
    ...（行为特征）
  C_Brain:
    brain_type  # none / simple_ai / group_ai / complex_ai
    ...（行为参数 / GOAP 配置）
```

### 1.3 种群 Population（局地种群）

```text
type: "Population"
components:
  C_Population:
    species_id
    region_id
    estimated_count        # 估计数量
    birth_rate
    death_rate
    migration_tendency
    mode                   # "simulated" | "derived_from_individuals"
    extinct_in_region      # 局地灭绝标记
    traits_bias            # 对 Species 的微小偏移（山地狼等）
```

### 1.4 势力 Faction（社会势力）

```text
type: "Faction"
components:
  C_Faction:
    name
    member_count_estimate
    territories: RegionId[]
    influence_map: Map<RegionId, influence_value>
    resources:
      food
      wealth
      military_power
      tech_level
      ...
    policies:
      war_tendency
      openness
      internal_order
      ...
    goals: [Goal]          # 给 GOAP 用的势力目标
    relations: Map<FactionId, relation_value> # 友好/敌对
```

> 统一抽象：
- **Creature** = 微观个体，负责局部行为和表现。
- **Population** = 某物种在某 Region 的“数值摘要”。
- **Faction** = 聚合个体意志的政治/社会实体。

---

## 2. HQ 区 / LQ 区：谁说了算？

### 2.1 单一真相原则

对于每个 `(species_id, region_id)` 组合：

- 若 `Population.mode = "simulated"`：  
    - **Population 是“真实数量持有者”**  
    - Population 级 Process 可以修改 `estimated_count`（生灭/迁移）。  
    - Creature 若存在，仅作表现，不影响生态统计。
- 若 `Population.mode = "derived_from_individuals"`：  
    - **Creature 集合是“真实数量持有者”**  
    - 生死迁徙全部通过 Creature 的 Process 完成。  
    - Population 只能统计，不允许独立改动 `estimated_count`。

> 这样就不会出现“种群说迁了 20 只狼，个体又自己反方向乱跑”的双重真相。

### 2.2 HQ/LQ 区切换

**从 LQ → HQ（远景 → 近景）**：

1. Population 在该 Region 的 `mode: "simulated" → "derived_from_individuals"`  
2. 按 `estimated_count` 和统计特征生成若干 Creature 实体：
    - 抽样年龄、性格、健康等。
3. 后续该 Region 内：
    - 种群统计由“数 Creature”得到；
    - 禁止 Population 自己做“真实生灭修改”。

**从 HQ → LQ（近景 → 远景）**：

1. 统计当前 Region 中所有 Creature（同物种）数量等资料；
2. 写回 Population：
    - `estimated_count = creature_count`
    - 更新健康指数等；
3. Despawn 大部分或全部普通 Creature（特殊 NPC 可保留）；  
4. Population 的 `mode: "derived_from_individuals" → "simulated"`，恢复种群级模拟。

---

## 3. 种群的生 / 流 / 灭（多种群 & 物种层次）

### 3.1 生：个体繁殖 + 种群级增长

**HQ 区：个体繁殖**

- 通过 `Process ReproduceCreature`：
    - 条件：父母双方满足繁殖条件（资源、状态、环境）；
    - Effect：
        - `SpawnEntity(new Creature)`；
- Population 不直接改数值，只在下一次统计时反映。

**LQ 区：种群级繁殖**

- 通过 `Process UpdatePopulationByRates`：
    - `estimated_count += birth_rate * dt - death_rate * dt + migration_in - migration_out`
    - 这是纯数值模拟，不涉及具体实体。

### 3.2 流：迁移 / 扩散

**个体层迁移（HQ 区）**：

- `Process MigrateCreature`:
    - Creature 按 NavMesh/路径规划，从坐标 A 走到 B；
    - 在跨 Region 边界时，顺便修改其 `region_id`；
    - Population 在统计时会记录：
        - 原 Region 的迁出；
        - 新 Region 的迁入。

**种群层迁移（LQ 区）**：

两种模式：

1. 连续迁移（逐 Region）：

```text
Process MigratePopulationChunk
  from: Region_A
  to:   Region_B
  amount: ΔN
```
    - 顺着 Region 邻接图走，比如：森林 → 山脚 → 山脊；
    - 适合普通动物、游牧群体。
2. 长程迁移（跨越多个 Region）：

```text
Process LongRangeMigration
  from: Region_A
  to:   Region_Z
  amount: ΔN
```
    - 适合候鸟、飞行生物、地底/超自然通道；
    - 可以表现“突然在遥远地方出现新种群”的现象。

### 3.3 灭：局地种群灭绝 & 物种灭绝

**局地种群灭绝（Population 层）**：

- 判定条件：
    - `estimated_count → 0` 且持续一定时间；  
    - 或 `< threshold_minimum_viable`（低于可持续规模）。
- Process 例：
    - `Process CheckPopulationExtinction`：
        - Effect：
            - `C_Population.extinct_in_region = true`
            - 触发生态连锁事件（天敌/猎物数量变化）。

**物种灭绝（Species 层）**：

- 当所有 Region 的 `Population(species, region)` 都标记为 `extinct_in_region`，  

    或 `estimated_count` 全为 0 时：

    - `Species.extinct = true`
    - 可以触发“物种绝迹”的世界事件（遗迹/神话/失传材料）。

> 总结：
- **同一物种可以有多个种群（多个 Population 实体）**；
- 每个种群有独立的生灭过程；
- 物种灭绝是“所有种群都死光了”的高层总结。

---

## 4. 个体与势力（Faction）的加入 / 退出

### 4.1 加入势力：Recruit / Convert / Conquer

统一抽象为高层 Action：`JoinFaction(faction_id)
`底层由若干 Process 组成，例如：

- `Process RecruitCreature`：
    - 条件：
        - 势力有 `JobSlot` / 机会；  
        - Creature 满足种族/关系/技能需求。
    - Effect：
        - `ChangeResource(creature, "faction_id", target_faction)`
        - `faction.member_count_estimate++`
- `Process ConvertFaith`（宗教效忠）：
    - 改变 creature 对某宗教势力的归属/忠诚标签。
- `Process EnslaveCreature`（奴役/征服）：
    - 设置 `creature.status = "slave"`
    - `faction_id = conquering_faction`

### 4.2 退出势力：Leave / Desert / Expel / Death

统一抽象为高层 Action：`LeaveFaction` 或 `ChangeFaction(new)`：

- 自愿离开：
    - `Process ResignFromFaction`
        - `creature.faction_id = null` 或 `faction = "wanderer"`
- 叛逃：
    - `Process DefectToFaction(new_faction)`
        - 旧势力 member--，新势力 member++；
        - 可能携带资源/情报。
- 被驱逐：
    - `Process ExpelCreature`
        - `creature.faction_id = null`
        - `relation(old_faction, creature) = hostile`
- 死亡：
    - `Process CreatureDeath`
        - 销毁 Creature 实体；
        - Population & Faction 在统计时减少对应数量。

### 4.3 驱动力：Opportunity + GOAP

- 势力提供的“机会 Entity”（JobSlot / Settlement / TradeOffer）  

    对 Creature 来说，是可选择的高价值 Option。
- Creature 的 GOAP 在规划时评估：
    - 留在当前 Faction vs 加入新 Faction 的收益和风险；
- 自然产生：
    - 迁徙、移民、雇佣、逃亡、叛乱等高等行为，无需写死剧情。

---

## 5. 势力（Faction）层的政治 / 经济涌现

### 5.1 Faction 作为高层 Actor

- Faction 也有 Resource 和 Goal：
    - `resources`：粮食、财富、军力、人口、科技…
    - `goals`：生存、扩张、威望、安全…
- 为 Faction 定义高层 Action（仍由原子 Process 组成）：
    - `Action: ExpandTerritory(region_x)`
    - `Action: LaunchRaidOn(faction_y)`
    - `Action: OfferTradeDeal(faction_y)`
    - `Action: FortifyBorder(region_z)`
- GOAP 在势力层上：
    - 把当前资源/威胁/关系作为 state；
    - 选取序列 Action 以实现中长期目标。

### 5.2 经济骨架

- 每个 Faction / Settlement：
    - `resource_stock[item]`
    - `production_rate[item]`
    - `consumption_rate[item]`
- Process：
    - `UpdateMarketDesire`：
        - 根据供需比计算每种资源的“渴望度 Desire”；
    - `AdjustPriceByDesire`：
        - `price[item] *= f(desire)`
    - `FactionTrade` / `SeekTrade`：
        - 根据价差和风险评估是否发起贸易。

玩家刷怪 / 贩卖素材 → 改变某势力的 `resource_stock` →
影响它的军事/扩张倾向 → 引发战争 / 联盟等宏观事件。

---

## 6. Region / Chunk 不是“棋格走路”，而是后台统计格

### 6.1 前台：连续世界 & NavMesh

- Creature 在连续坐标或 NavMesh 上移动、战斗、觅食；
- 玩家看到的是自然的路径和行为。

### 6.2 后台：Region 作为生态/政治统计单位

- Region 代表：
    - 一片森林、一段山脊、一个城镇周边……
- Population / Faction 的数量、领地，是按 Region 统计的：
    - `Population(species, region).estimated_count`
    - `Faction.territories: RegionId[]`

### 6.3 迁移既可以“逐 Region”，也可以“长程跳跃”

- 普通动物：
    - `MigratePopulationChunk`：沿 Region 邻接图缓慢移动。
- 特殊物种（飞行、超自然）：
    - `LongRangeMigration`：直接在远方 Region 出现。

前台表现：

- HQ 区：
    - 真正的个体一步步在地形上走；
- LQ 区：
    - 只看到结果：这些生物出现在遥远的新生态位。

---

## 7. ERPE 总结：统一视角下的个体 / 种群 / 势力

1. **Entity 统一**：  
    - `Creature_X`、`Population_Wolf_NorthForest`、`Faction_HumanKingdom` 都是 Entity；
    - 区别仅在于组件和参与的 Process 类型。
2. **Resource 统一**：  
    - `HP`, `Hunger`, `estimated_count`, `member_count_estimate`, `resources.food`...  
    - 都是数值型/状态型 Resource，Process 读写它们产生 Effect。
3. **Process 粒度统一**：  
    - 不论是：
        - `ReproduceCreature`
        - `UpdatePopulationByRates`
        - `MigratePopulationChunk`
        - `JoinFaction`
        - `FactionExpandToRegion`
    - 都是“可以在小说里用一句话描述的原子动作/判断”。
4. **Effect & 日志统一**：  

    所有变化进入同一本“世界账本”：

```text
t = 120.0
Effect: EntityMove
  entity = Creature_Wolf_123
  from = Region_NorthForest
  to   = Region_SouthHills

t = 120.0
Effect: PopulationChange
  entity = Population_Wolf_NorthForest
  delta  = -1

t = 120.0
Effect: PopulationChange
  entity = Population_Wolf_SouthHills
  delta  = +1

t = 320.0
Effect: SpeciesStatusChange
  species = Wolf
  extinct = true
```

    上面这一组就描述了从个体迁移，到种群统计变化，到物种灭绝的完整链条。

---

## 8. 设计规范（可贴在文档顶部）

1. **单一真相原则**
对于每个 `(species, region)`，同一时刻只能由 Creature 或 Population 之一持有“真实数量”：
- HQ 区：Creature 为真，Population 为视图；
- LQ 区：Population 为真，Creature 为抽样/表现。

2. **模式切换原则**
Population 用 `mode = "simulated" / "derived_from_individuals"` 标记当前职责；
切换模式时：
- 总是先用“真实层”的状态推导“视图层”；
- 再冻结“视图层”的生死迁徙 Process。

3. **多种群 & 物种灭绝原则**
同一物种可有多个 Population（不同 Region）；
每个 Population 独立生灭；
当所有 Population 灭绝时，在 Species 层标记物种灭绝。

4. **加入/退出势力统一原则**
个体与势力关系通过 `C_FactionRef.faction_id` 表示；
加入、退出、叛逃、驱逐，全部由标准 Process 改写该 Resource，
并同步影响 Faction 的 Resource（member_count、军力等）。

5. **“棋盘”只存在于后台**
Region / Chunk 仅用于生态、经济、政治层的统计和规划；
前台 Creature 行为始终在连续世界中自然表现。

